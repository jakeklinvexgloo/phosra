openapi: 3.1.0
info:
  title: Phosra API
  description: Universal Parental Controls API - Define once, push everywhere
  version: 1.0.0
  contact:
    name: Phosra
servers:
  - url: http://localhost:8080/api/v1
    description: Local development

security:
  - BearerAuth: []

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    DeviceKeyAuth:
      type: apiKey
      in: header
      name: X-Device-Key
      description: Device API key issued at registration (stored in iOS Keychain)

  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        code:
          type: integer

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        name:
          type: string
        created_at:
          type: string
          format: date-time

    TokenPair:
      type: object
      properties:
        access_token:
          type: string
        refresh_token:
          type: string
        expires_at:
          type: string
          format: date-time

    Family:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        created_at:
          type: string
          format: date-time

    FamilyMember:
      type: object
      properties:
        id:
          type: string
          format: uuid
        family_id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        role:
          type: string
          enum: [owner, parent, guardian]
        joined_at:
          type: string
          format: date-time

    Child:
      type: object
      properties:
        id:
          type: string
          format: uuid
        family_id:
          type: string
          format: uuid
        name:
          type: string
        birth_date:
          type: string
          format: date
        avatar_url:
          type: string
        created_at:
          type: string
          format: date-time

    ChildPolicy:
      type: object
      properties:
        id:
          type: string
          format: uuid
        child_id:
          type: string
          format: uuid
        name:
          type: string
        status:
          type: string
          enum: [active, paused, draft]
        priority:
          type: integer
        created_at:
          type: string
          format: date-time

    PolicyRule:
      type: object
      properties:
        id:
          type: string
          format: uuid
        policy_id:
          type: string
          format: uuid
        category:
          type: string
          enum:
            - content_rating
            - content_block_title
            - content_allow_title
            - content_allowlist_mode
            - content_descriptor_block
            - time_daily_limit
            - time_scheduled_hours
            - time_per_app_limit
            - time_downtime
            - purchase_approval
            - purchase_spending_cap
            - purchase_block_iap
            - social_contacts
            - social_chat_control
            - social_multiplayer
            - web_safesearch
            - web_category_block
            - web_custom_allowlist
            - web_custom_blocklist
            - web_filter_level
            - privacy_location
            - privacy_profile_visibility
            - privacy_data_sharing
            - privacy_account_creation
            - monitoring_activity
            - monitoring_alerts
        enabled:
          type: boolean
        config:
          type: object
        created_at:
          type: string
          format: date-time

    Provider:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        category:
          type: string
          enum: [dns, streaming, gaming, device, browser]
        tier:
          type: string
          enum: [live, partial, stub]
        description:
          type: string
        auth_type:
          type: string
          enum: [api_key, oauth2, manual]
        capabilities:
          type: array
          items:
            type: string

    ProviderConnection:
      type: object
      properties:
        id:
          type: string
          format: uuid
        family_id:
          type: string
          format: uuid
        provider_id:
          type: string
        status:
          type: string
          enum: [connected, disconnected, error]
        last_sync_at:
          type: string
          format: date-time
        last_sync_status:
          type: string
        connected_at:
          type: string
          format: date-time

    SyncJob:
      type: object
      properties:
        id:
          type: string
          format: uuid
        child_id:
          type: string
          format: uuid
        policy_id:
          type: string
          format: uuid
        trigger_type:
          type: string
          enum: [manual, auto, webhook]
        status:
          type: string
          enum: [pending, running, completed, failed, partial]
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time

    SyncJobResult:
      type: object
      properties:
        id:
          type: string
          format: uuid
        sync_job_id:
          type: string
          format: uuid
        provider_id:
          type: string
        status:
          type: string
        rules_applied:
          type: integer
        rules_skipped:
          type: integer
        rules_failed:
          type: integer
        error_message:
          type: string
        details:
          type: object

    RatingSystem:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        country:
          type: string
        media_type:
          type: string

    Rating:
      type: object
      properties:
        id:
          type: string
          format: uuid
        system_id:
          type: string
        code:
          type: string
        name:
          type: string
        min_age:
          type: integer
        restrictive_idx:
          type: integer

    AgeRatings:
      type: object
      properties:
        age:
          type: integer
        ratings:
          type: object
          additionalProperties:
            $ref: "#/components/schemas/Rating"

    DeviceRegistration:
      type: object
      properties:
        id:
          type: string
          format: uuid
        child_id:
          type: string
          format: uuid
        family_id:
          type: string
          format: uuid
        platform_id:
          type: string
        device_name:
          type: string
        device_model:
          type: string
        os_version:
          type: string
        app_version:
          type: string
        apns_token:
          type: string
          nullable: true
        capabilities:
          type: array
          items:
            type: string
          description: "Apple frameworks the device supports (e.g. FamilyControls, ManagedSettings, DeviceActivity)"
        enforcement_summary:
          type: object
          description: "Per-category enforcement results from the device's last enforcement_status report"
        last_seen_at:
          type: string
          format: date-time
          nullable: true
        last_policy_version:
          type: integer
        status:
          type: string
          enum: [active, inactive, revoked]
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    RegisterDeviceRequest:
      type: object
      required: [device_name, device_model, os_version, app_version]
      properties:
        device_name:
          type: string
        device_model:
          type: string
        os_version:
          type: string
        app_version:
          type: string
        apns_token:
          type: string
        capabilities:
          type: array
          items:
            type: string
          description: "Apple frameworks the device supports (e.g. FamilyControls, ManagedSettings, DeviceActivity)"

    RegisterDeviceResponse:
      type: object
      properties:
        device:
          $ref: "#/components/schemas/DeviceRegistration"
        api_key:
          type: string
          description: One-time device API key (store in Keychain)

    UpdateDeviceRequest:
      type: object
      properties:
        device_name:
          type: string
        apns_token:
          type: string
        app_version:
          type: string
        os_version:
          type: string

    CompiledPolicy:
      type: object
      properties:
        version:
          type: integer
        child_id:
          type: string
          format: uuid
        child_age:
          type: integer
        age_group:
          type: string
        policy_id:
          type: string
          format: uuid
        status:
          type: string
        generated_at:
          type: string
          format: date-time
        content_filter:
          type: object
          properties:
            age_rating:
              type: string
            max_ratings:
              type: object
              additionalProperties:
                type: string
            blocked_apps:
              type: array
              items:
                type: string
            allowed_apps:
              type: array
              items:
                type: string
            allowlist_mode:
              type: boolean
        screen_time:
          type: object
          properties:
            daily_limit_minutes:
              type: integer
            per_app_limits:
              type: array
              items:
                type: object
                properties:
                  bundle_id:
                    type: string
                  daily_minutes:
                    type: integer
            downtime_windows:
              type: array
              items:
                type: object
                properties:
                  days_of_week:
                    type: array
                    items:
                      type: string
                  start_time:
                    type: string
                  end_time:
                    type: string
            always_allowed_apps:
              type: array
              items:
                type: string
            schedule:
              type: object
              properties:
                weekday:
                  type: object
                  properties:
                    start:
                      type: string
                    end:
                      type: string
                weekend:
                  type: object
                  properties:
                    start:
                      type: string
                    end:
                      type: string
        purchases:
          type: object
          properties:
            require_approval:
              type: boolean
            block_iap:
              type: boolean
            spending_cap_usd:
              type: number
        privacy:
          type: object
          properties:
            location_sharing_enabled:
              type: boolean
            profile_visibility:
              type: string
            account_creation_approval:
              type: boolean
            data_sharing_restricted:
              type: boolean
        social:
          type: object
          properties:
            chat_mode:
              type: string
            dm_restriction:
              type: string
            multiplayer_mode:
              type: string
        notifications:
          type: object
          properties:
            curfew_start:
              type: string
            curfew_end:
              type: string
            usage_timer_minutes:
              type: integer
        web_filter:
          type: object
          properties:
            level:
              type: string
            safe_search:
              type: boolean
            blocked_domains:
              type: array
              items:
                type: string
            allowed_domains:
              type: array
              items:
                type: string
            blocked_categories:
              type: array
              items:
                type: string

    DeviceReportRequest:
      type: object
      required: [report_type, payload, reported_at]
      properties:
        report_type:
          type: string
          enum: [screen_time, app_usage, web_activity, blocked_attempt, enforcement_status]
        payload:
          type: object
          description: "Report data (varies by report_type). For enforcement_status see EnforcementStatusPayload."
        reported_at:
          type: string
          format: date-time

    EnforcementStatusPayload:
      type: object
      description: "Payload for report_type: enforcement_status — per-category enforcement results"
      properties:
        policy_version:
          type: integer
          description: "The policy version these results correspond to"
        results:
          type: array
          items:
            $ref: "#/components/schemas/CategoryEnforcementResult"

    CategoryEnforcementResult:
      type: object
      properties:
        category:
          type: string
          description: "Phosra rule category (e.g. content_rating, time_daily_limit)"
        status:
          type: string
          enum: [enforced, partial, failed, unsupported]
          description: "Enforcement outcome on this device"
        framework:
          type: string
          description: "Apple framework used (ManagedSettings, DeviceActivity, FamilyControls, none)"
        detail:
          type: string
          description: "Optional error message or implementation note"

    CategoryFrameworkMapping:
      type: object
      description: "Maps a Phosra rule category to the Apple framework and API class needed to enforce it"
      properties:
        framework:
          type: string
          description: "Apple framework: ManagedSettings, DeviceActivity, FamilyControls, or none"
        api_class:
          type: string
          description: "Specific API class (e.g. ManagedSettingsStore.webContent, DeviceActivitySchedule)"
        min_os:
          type: string
          description: "Minimum iOS version required (e.g. 16.0)"
        notes:
          type: string
          description: "Implementation hints for the iOS app"

    ApplePlatformMappings:
      type: object
      properties:
        age_ratings:
          type: object
          additionalProperties:
            type: string
        app_categories:
          type: object
          additionalProperties:
            type: object
            properties:
              bundle_ids:
                type: array
                items:
                  type: string
              app_store_category:
                type: string
        system_apps:
          type: object
          additionalProperties:
            type: string
        always_allowed:
          type: array
          items:
            type: string
        category_frameworks:
          type: object
          description: "Phosra rule category → Apple framework mapping for on-device enforcement"
          additionalProperties:
            $ref: "#/components/schemas/CategoryFrameworkMapping"

paths:
  /auth/register:
    post:
      summary: Register a new account
      tags: [Auth]
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password, name]
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  minLength: 8
                name:
                  type: string
      responses:
        "201":
          description: Account created
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: "#/components/schemas/User"
                  tokens:
                    $ref: "#/components/schemas/TokenPair"
        "409":
          description: Email already registered

  /auth/login:
    post:
      summary: Login
      tags: [Auth]
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                password:
                  type: string
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: "#/components/schemas/User"
                  tokens:
                    $ref: "#/components/schemas/TokenPair"
        "401":
          description: Invalid credentials

  /auth/refresh:
    post:
      summary: Refresh access token
      tags: [Auth]
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refresh_token]
              properties:
                refresh_token:
                  type: string
      responses:
        "200":
          description: Token refreshed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenPair"

  /auth/logout:
    post:
      summary: Logout (revoke refresh tokens)
      tags: [Auth]
      responses:
        "204":
          description: Logged out

  /auth/me:
    get:
      summary: Get current user
      tags: [Auth]
      responses:
        "200":
          description: Current user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"

  /families:
    get:
      summary: List user's families
      tags: [Families]
      responses:
        "200":
          description: Family list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Family"
    post:
      summary: Create a family
      tags: [Families]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
      responses:
        "201":
          description: Family created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Family"

  /families/{familyID}:
    parameters:
      - name: familyID
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      summary: Get family
      tags: [Families]
      responses:
        "200":
          description: Family details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Family"
    put:
      summary: Update family
      tags: [Families]
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
      responses:
        "200":
          description: Updated
    delete:
      summary: Delete family
      tags: [Families]
      responses:
        "204":
          description: Deleted

  /families/{familyID}/children:
    parameters:
      - name: familyID
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      summary: List children in family
      tags: [Children]
      responses:
        "200":
          description: Children list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Child"
    post:
      summary: Add child to family
      tags: [Children]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, birth_date]
              properties:
                name:
                  type: string
                birth_date:
                  type: string
                  format: date
      responses:
        "201":
          description: Child added

  /children/{childID}:
    parameters:
      - name: childID
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      summary: Get child
      tags: [Children]
      responses:
        "200":
          description: Child details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Child"
    put:
      summary: Update child
      tags: [Children]
      responses:
        "200":
          description: Updated
    delete:
      summary: Delete child
      tags: [Children]
      responses:
        "204":
          description: Deleted

  /children/{childID}/age-ratings:
    parameters:
      - name: childID
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      summary: Get age-appropriate ratings for child
      tags: [Children]
      responses:
        "200":
          description: Age ratings
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AgeRatings"

  /children/{childID}/policies:
    parameters:
      - name: childID
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      summary: List child's policies
      tags: [Policies]
      responses:
        "200":
          description: Policy list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ChildPolicy"
    post:
      summary: Create policy for child
      tags: [Policies]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
      responses:
        "201":
          description: Policy created

  /policies/{policyID}/activate:
    post:
      summary: Activate policy
      tags: [Policies]
      parameters:
        - name: policyID
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Policy activated

  /policies/{policyID}/pause:
    post:
      summary: Pause policy
      tags: [Policies]
      parameters:
        - name: policyID
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Policy paused

  /policies/{policyID}/generate-from-age:
    post:
      summary: Auto-generate rules based on child's age
      tags: [Policies]
      parameters:
        - name: policyID
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Rules generated
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/PolicyRule"

  /policies/{policyID}/rules:
    parameters:
      - name: policyID
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      summary: List policy rules
      tags: [Policy Rules]
      responses:
        "200":
          description: Rule list
    post:
      summary: Create rule
      tags: [Policy Rules]
      responses:
        "201":
          description: Rule created

  /providers:
    get:
      summary: List all providers
      tags: [Providers]
      security: []
      responses:
        "200":
          description: Provider list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Provider"

  /connections:
    post:
      summary: Connect to a provider
      tags: [Connections]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [family_id, provider_id, credentials]
              properties:
                family_id:
                  type: string
                  format: uuid
                provider_id:
                  type: string
                credentials:
                  type: string
      responses:
        "201":
          description: Connected

  /children/{childID}/sync:
    post:
      summary: Trigger sync for child across all providers
      tags: [Sync]
      parameters:
        - name: childID
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "202":
          description: Sync triggered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SyncJob"

  /sync/jobs/{jobID}:
    get:
      summary: Get sync job status
      tags: [Sync]
      parameters:
        - name: jobID
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Job status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SyncJob"

  /sync/jobs/{jobID}/results:
    get:
      summary: Get sync job results per provider
      tags: [Sync]
      parameters:
        - name: jobID
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Job results
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/SyncJobResult"

  /ratings/systems:
    get:
      summary: List rating systems
      tags: [Ratings]
      security: []
      responses:
        "200":
          description: Rating systems

  /ratings/by-age:
    get:
      summary: Get ratings for a specific age
      tags: [Ratings]
      security: []
      parameters:
        - name: age
          in: query
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Age-appropriate ratings

  # ── Apple Device Sync ────────────────────────────────────────────

  /children/{childID}/devices:
    parameters:
      - name: childID
        in: path
        required: true
        schema:
          type: string
          format: uuid
    post:
      summary: Register an Apple device
      tags: [Apple Device Sync]
      description: Register a device for on-device policy enforcement. Returns a one-time API key the iOS app stores in Keychain.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterDeviceRequest"
      responses:
        "201":
          description: Device registered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RegisterDeviceResponse"
        "404":
          description: Child not found
    get:
      summary: List registered devices for a child
      tags: [Apple Device Sync]
      responses:
        "200":
          description: Device list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/DeviceRegistration"

  /devices/{deviceID}:
    parameters:
      - name: deviceID
        in: path
        required: true
        schema:
          type: string
          format: uuid
    put:
      summary: Update device metadata
      tags: [Apple Device Sync]
      description: Update APNs token, app version, or device name. All fields are optional.
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateDeviceRequest"
      responses:
        "200":
          description: Device updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeviceRegistration"
        "404":
          description: Device not found
    delete:
      summary: Revoke a device
      tags: [Apple Device Sync]
      description: Revoke the device's API key. The device will receive 401 on its next request.
      responses:
        "204":
          description: Device revoked

  /device/policy:
    get:
      summary: Get compiled policy for device
      tags: [Apple Device Sync]
      security:
        - DeviceKeyAuth: []
      description: Returns a structured policy document the iOS app interprets to configure FamilyControls/ManagedSettings. Supports conditional polling via since_version query parameter.
      parameters:
        - name: since_version
          in: query
          description: Return 304 if policy version is <= this value
          schema:
            type: integer
      responses:
        "200":
          description: Compiled policy document
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompiledPolicy"
        "304":
          description: Policy unchanged since the given version
        "401":
          description: Invalid or revoked device key

  /device/report:
    post:
      summary: Submit activity report from device
      tags: [Apple Device Sync]
      security:
        - DeviceKeyAuth: []
      description: "Submit screen time, app usage, or other activity data. Stored in device_reports and fanned out to activity_logs. Use report_type: enforcement_status with an EnforcementStatusPayload to report per-category enforcement results; this also updates the device's enforcement_summary for the parent dashboard."
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DeviceReportRequest"
      responses:
        "202":
          description: Report accepted
        "401":
          description: Invalid or revoked device key

  /device/ack:
    post:
      summary: Acknowledge policy version
      tags: [Apple Device Sync]
      security:
        - DeviceKeyAuth: []
      description: Confirm that the device has successfully applied a specific policy version.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [version]
              properties:
                version:
                  type: integer
      responses:
        "200":
          description: Version acknowledged
          content:
            application/json:
              schema:
                type: object
                properties:
                  acknowledged_version:
                    type: integer
        "401":
          description: Invalid or revoked device key

  /platform-mappings/{platformID}:
    parameters:
      - name: platformID
        in: path
        required: true
        schema:
          type: string
    get:
      summary: Get platform-specific identifier mappings
      tags: [Apple Device Sync]
      security: []
      description: "Returns Apple bundle IDs, age ratings, system apps, always-allowed apps, and category_frameworks mapping (which Apple framework + API class to use for each Phosra rule category). Currently only supports platformID=apple."
      responses:
        "200":
          description: Platform mappings
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApplePlatformMappings"
        "404":
          description: Platform not supported
